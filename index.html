<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>êµë³µ ì°©ìš© ì²´í¬ â€“ ë²„íŠ¼í˜• + ëˆ„ì  ìˆœìœ„(ì „ì²´/í•™ë…„) + ë²ˆí˜¸í¸ì§‘</title>
<style>
  :root{--bg:#f6f8fb;--card:#fff;--text:#0f172a;--muted:#64748b;--brand:#2563eb;--ring:rgba(37,99,235,.18);--shadow:0 10px 24px rgba(15,23,42,.06);--radius:16px}
  html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,"Apple SD Gothic Neo","Noto Sans KR",Segoe UI,Roboto,Helvetica,Arial}
  .container{max-width:1080px;margin:22px auto 60px;padding:0 16px}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow)}
  .header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px}
  .title{font-weight:800;display:flex;gap:10px;align-items:center}
  .section{padding:14px 16px;border-top:1px solid #eef2f7}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .seg{display:inline-flex;background:#eef2ff;border-radius:12px;padding:4px}
  .seg .seg-btn{border:0;background:transparent;padding:7px 12px;border-radius:10px;cursor:pointer;font-weight:800;color:#334155}
  .seg .seg-btn.active{background:#fff;box-shadow:var(--shadow);color:#1d4ed8}
  .btn{appearance:none;border:1px solid #e5e7eb;background:#fff;color:#0f172a;padding:8px 12px;border-radius:12px;cursor:pointer;font-weight:700}
  .btn:hover{transform:translateY(-1px)}
  .btn.brand{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn.small{padding:6px 10px;border-radius:10px}
  .pill{display:inline-flex;gap:8px;align-items:center;background:#f1f5f9;border:1px solid #e5e7eb;padding:6px 10px;border-radius:9999px;font-weight:800;cursor:pointer}
  input[type="date"],input[type="text"],input[type="number"]{border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px}
  input:focus{border-color:var(--brand);box-shadow:0 0 0 4px var(--ring);outline:0}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  @media (min-width:680px){.grid{grid-template-columns:repeat(4,minmax(0,1fr))}}
  .student{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border:1px solid #e5e7eb;border-radius:14px;background:#fff;cursor:pointer}
  .student .nm{font-weight:800;display:flex;align-items:center;gap:8px}
  .on{background:#ecfdf5;border-color:#10b981}
  .off{background:#fff;border-color:#e5e7eb}
  .muted{color:#64748b}
  .del{margin-left:8px;background:#fee2e2;border:0;border-radius:8px;padding:2px 6px;cursor:pointer;color:#b91c1c;font-weight:900}
  .num{width:64px}
  .divider{height:1px;background:#eef2f7;margin:10px 0}
  .footer{font-size:13px;color:#64748b}
  .modal{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;padding:18px}
  .modal.show{display:flex}
  .modal .box{background:#fff;border-radius:16px;width:100%;max-width:720px;box-shadow:var(--shadow)}
  .modal .hd{padding:12px 16px;border-bottom:1px solid #eef2f7;display:flex;align-items:center;justify-content:space-between}
  .modal .bd{padding:12px 16px}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid #e5e7eb;padding:8px 6px;text-align:left}
  .table th{background:#f8fafc}
  .seg-alt{display:inline-flex;background:#f1f5f9;border-radius:12px;padding:4px;margin-right:8px}
  .seg-alt button{border:0;background:transparent;padding:6px 10px;border-radius:10px;cursor:pointer;font-weight:800}
  .seg-alt button.active{background:#fff;box-shadow:var(--shadow);color:#1d4ed8}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="header">
      <div class="title">ğŸ§¥ êµë³µ ì°©ìš© ì²´í¬</div>
      <div class="row">
        <button class="btn small" id="btn-print">ğŸ–¨ï¸ ì¸ì‡„</button>
        <button class="btn small" id="btn-settings">âš™ï¸ ì €ì¥ì†Œ ì„¤ì •</button>
        <button class="btn small brand" id="btn-save-github">ğŸ’¾ ì €ì¥(GitHub)</button>
        <a class="btn small" href="https://gptonline.ai/ko/" target="_blank" rel="noopener">í•œêµ­í˜• GPT</a>
      </div>
    </div>

    <div class="section">
      <div class="row">
        <label>ë‚ ì§œ</label><input type="date" id="dateInput">
        <span class="pill" id="summaryPill" title="ëˆ„ì  ìˆœìœ„ ë³´ê¸°">ì´ 0ëª… Â· âœ… 0</span>
        <input type="text" id="searchInput" placeholder="í•™ìƒ ì´ë¦„ ê²€ìƒ‰" style="min-width:180px">
        <button class="btn small" id="btn-add">í•™ìƒ ì¶”ê°€</button>
        <button class="btn small" id="btn-edit">í¸ì§‘ ëª¨ë“œ</button>
        <button class="btn small" id="btn-save-order" style="display:none">ë²ˆí˜¸ ì €ì¥</button>
        <button class="btn small" id="btn-select-all">ì „ì²´ ì„ íƒ</button>
        <button class="btn small" id="btn-clear">ì „ì²´ í•´ì œ</button>
        <button class="btn small" id="btn-ranking">ğŸ† ëˆ„ì  ìˆœìœ„</button>
      </div>
    </div>

    <div class="section">
      <div class="row" style="justify-content:space-between">
        <div class="seg" id="seg-grade"></div>
        <div class="seg" id="seg-class"></div>
      </div>
      <div class="divider"></div>
      <div class="grid" id="grid"></div>
    </div>

    <div class="section footer">
      â€» ì´ í˜ì´ì§€ëŠ” **ëˆ„êµ¬ë‚˜ ìˆ˜ì • ê°€ëŠ¥**í•©ë‹ˆë‹¤(ë¸Œë¼ìš°ì €ì—ì„œ ì²´í¬/í¸ì§‘). ì €ì¥ì€ **GitHub ì €ì¥ì†Œ**ì— JSON íŒŒì¼ë¡œ ì»¤ë°‹ë©ë‹ˆë‹¤.
    </div>
  </div>
</div>

<!-- ì €ì¥ì†Œ ì„¤ì • ëª¨ë‹¬ -->
<div class="modal" id="modal">
  <div class="box">
    <div class="hd">
      <strong>GitHub ì €ì¥ì†Œ ì„¤ì •</strong>
      <button class="btn small" id="btn-close">ë‹«ê¸°</button>
    </div>
    <div class="bd">
      <div class="row" style="gap:10px;margin:6px 0"><label style="min-width:160px">Owner</label><input id="ghOwner" placeholder="your-id" style="flex:1"></div>
      <div class="row" style="gap:10px;margin:6px 0"><label style="min-width:160px">Repository</label><input id="ghRepo" placeholder="uniform-checker-data" style="flex:1"></div>
      <div class="row" style="gap:10px;margin:6px 0"><label style="min-width:160px">Branch</label><input id="ghBranch" value="main" style="flex:1"></div>
      <div class="row" style="gap:10px;margin:6px 0"><label style="min-width:160px">Base Path</label><input id="ghBase" value="data" style="flex:1"></div>
      <div class="row" style="gap:10px;margin:6px 0"><label style="min-width:160px">Token</label><input id="ghToken" placeholder="ghp_..." type="password" style="flex:1"></div>
      <div class="row" style="margin-top:10px">
        <button class="btn brand small" id="btn-save-settings">ì„¤ì • ì €ì¥</button>
        <button class="btn small" id="btn-reset-settings">ì´ˆê¸°í™”</button>
        <button class="btn small" id="btn-wipe-local" title="ë¡œì»¬ ì €ì¥ ëª…ë‹¨/ì²´í¬ ì´ˆê¸°í™”">ë¡œì»¬ ë°ì´í„° ì´ˆê¸°í™”</button>
      </div>
      <div class="muted" style="margin-top:6px">â€» fine-grained í† í°ì— <code>contents:write</code> ê¶Œí•œì„ ê¶Œì¥í•©ë‹ˆë‹¤.</div>
    </div>
  </div>
</div>

<!-- ëˆ„ì  ìˆœìœ„ ëª¨ë‹¬ -->
<div class="modal" id="rankModal">
  <div class="box">
    <div class="hd">
      <strong>ğŸ† ëˆ„ì  ìˆœìœ„</strong>
      <button class="btn small" id="btn-close-rank">ë‹«ê¸°</button>
    </div>
    <div class="bd">
      <div class="row" style="margin-bottom:8px">
        <div class="seg-alt" id="scopeSeg">
          <button data-scope="all" class="active">ì „ì²´</button>
          <button data-scope="grade">í•™ë…„ë³„</button>
        </div>
        <div class="seg-alt" id="gradeSeg" style="display:none">
          <button data-grade="1í•™ë…„" class="active">1í•™ë…„</button>
          <button data-grade="2í•™ë…„">2í•™ë…„</button>
          <button data-grade="3í•™ë…„">3í•™ë…„</button>
        </div>
        <button class="btn small" id="btn-refresh-rank">GitHubì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
      <table class="table">
        <thead><tr><th style="width:70px">ìˆœìœ„</th><th>í•™ìƒ</th><th style="width:100px">âœ… ëˆ„ì </th></tr></thead>
        <tbody id="rankBody"></tbody>
      </table>
      <div class="muted" id="rankHint" style="margin-top:6px"></div>
    </div>
  </div>
</div>

<script>
/* ===== ê¸°ë³¸ ë°ì´í„° (2-2 ë°˜ í™•ì • í¬í•¨) ===== */
const DEFAULT_ROSTERS={
  "1-1":["ê³ ìˆ˜ë¯¼","êµ¬ì£¼ì˜","ê¸¸ì„ ìˆ˜","ê¹€ê°€ì›","ê¹€ë‹¤í•¨","ê¹€ìˆ˜ë¹ˆ","ê¹€íƒœì„","ê¹€íƒœí¬","ê¹€í•˜ì€","ë¬¸ì§€ë¯¼","ë°•ì„ ì›…","ë°•ì†Œì˜","ì†¡ê±´ì˜","ìœ¤ëŒ€ì›","ìœ¤í˜„ìš°","ì´ê°€ë¹ˆ","ì´ìˆ˜í˜„","ì´ì •ë¯¼","ì •ì§€ìš°","ì •ì°¬ìš©","ì§€ì˜ë¯¼","í™©ê°€ì˜¨"],
  "1-2":["ê³µë³‘í˜¸","ê¸¸ë¹ˆë‚˜","ê¹€ì˜ë¯¼","ê¹€í•˜ìœ¤","ë°•ë²”êµ­","ì‹ ê´€ìš°","ìš©ìˆ˜ë¹ˆ","ìœ¤íƒœí¬","ì´ë‚˜ê²½","ì´ë¯¼ì£¼","ì´ìœ¤ì•„","ì´ì •í›ˆ","ì„ì„œí›„","ì„ì¤€ìš°","ì¥ì„œì—°","ì¥ì§€í›ˆ","ì „ì‚¬ëª…","ì „ìƒë¯¼","ì¡°ì€","ì£¼ì†”ë¹ˆ","ì§€ìˆ˜ì—°","ìµœì§€ìœ ","í•œë™í•˜"],
  "1-3":["ê°•ì§€í˜¸","ê¹€ë¯¼ì •","ê¹€ìƒìš±","ê¹€ìš©ì‹","ê¹€ì£¼í˜„","ê¹€ì§€í™˜","ê¹€íš¨ì¸","ë°•ì„œì—°","ë°•ì€ë¹ˆ","ë°•ì°¬ì¤€","ë°±ì„±í˜„","ì‹ ì†Œì—°","ì‹¬í˜„ë¥ ","ì•ˆì˜ˆì§„","ì•ˆì§€ì˜","ì˜¤ìœ ì¤€","ìœ¤ê°•ì‚°","ìœ¤ì„¸ì˜","ìœ¤ì‹œí›„","ì´ìˆ˜ì•„","ì •ì˜ˆì„œ","í•œì§€ë¯¼","ë‚¨ê¶ë™í™˜"],
  "2-1":["ê³ ì€í˜œ","êµ¬ìŠ¹ëª¨","ê¹€ë‚˜ê²½","ê¹€ì¤€í˜¸","ê¹€ì±„ë¯¼","ê¹€í˜„ë¹ˆ","ê¹€í¬ì„œ","ë„ê°€ì˜","ë¯¼ìˆ˜ì—°","ë°•ì˜ˆì†”","ë°•ì§€í™","ì†¡ì§„ì„±","ì´ìŠ¬ë¹„","ì´ì£¼í˜„","ì´ì¤€í˜","ì´ì²­í•˜","ì´í˜•ì§„","ì¡°ë¯¼ì„œ","ì¡°ìœ ë¹ˆ","ì¡°ì€ì°¬","í•˜ìŠ¹í˜¸"],
  "2-2":["ê¹€ë„ìœ¤","ê¹€ì€ë¹ˆ","ì‹ ìœ ì°¬","ì‹ ì§€ì—°","ì•ˆí˜•ì¤€","ì´ê²½ë¯¼","ì´ë‹¤í¬","ì´ì˜ˆë¦°","ì´ìš©íœ˜","ì´ì§€ì—°","ì´ì§€ìœ¤","ì„ì§€í›„","ì „ì„œí˜„","ì •ë¯¼êµ","ì •ìˆ˜ë¯¼","ì •í•œê²°","ì£¼ì¬ë¹ˆ","ìµœì—°ìš°","ìµœì£¼í˜¸","í—ˆí˜„í˜¸","í™©ì±„í¬"],
  "2-3":["ê¸¸ê²½ë¦¼","ê¸¸ë‚˜ì—°","ê¸¸í˜œë¯¸","ê¹€ê°€ì€","ê¹€ìš°ì² ","ê¹€ì›í˜¸","ê¹€ì§€ìš°","ê¹€íš¨ìš°","ë°•ì§„ì—½","ì†ë¯¼ì •","ì•ˆì˜ˆì›","ì–‘í¬ë°±","ì˜¤ì§€ìœ ","ìš©í•˜ì€","ìœ ì˜¨ìœ ","ìœ ì¬ì›…","ì´ìœ ë¹ˆ","ì´ì°¨ìœ¤","ì •ë¯¼ì¤€","ì¡°ì¸ì„­","ìµœê°€ì¸","ìµœì†Œì˜","í•œì§€ì˜","í˜„ì§€ì„±"],
  "3-1":["ê³ ê²½ë¯¼","ê¹€ê·œì—°","ê¹€ë³´í›ˆ","ê¹€ì„ ìš°","ê¹€ì‹œì€","ê¹€ì°¬í˜„","ê¹€íš¨ì •","ë°•ì˜ìš±","ë°•ìœ¤ì„±","ë°•ì§€ìš°","ë°±ì„œí˜„","ì†¡ì •í™˜","ì´ì„œìœ¤","ì´ì„œí˜„","ì´ìœ ì¤€","ì´ì€ë¹„","ì´ì€ì§„","ì´í•˜ì˜","ì¥ìˆ˜ë¯¼","ì •ì¬ì—­","ì¡°ì¤‘í˜„","ìµœìœ¤ì„œ","ìµœí¬ìˆ˜"],
  "3-2":["ê¹€ë‹¨ì˜¤","ê¹€ë¯¼ì—½","ê¹€ìœ ë‚˜","ê¹€ì¬ì›","ê¹€í˜¸ì—°","ë‚¨ëŒ€í˜¸","ë°•ì°¬í˜„","ë³µì„ ì˜","ì†ì§€ë¯¼","ì‹ ê°€ì›","ì—„ì†Œìœ¨","ì˜¤ì±„í˜„","ìš©í˜„ë¹ˆ","ìš°ë‹¤ì—°","ìœ ìˆ˜ì—°","ì´ì„œì›","ì´ì€ìš°","ì¥ì„œì§„","ì¥ìˆ˜ë¯¼","ì¥ì˜ë¯¼","ì •ì‹œì—°","ì •ì§€ë¯¼","ì£¼ê°€ì˜"],
  "3-3":["ê°•íƒœì´","ê¹€ë™ì—°","ê¹€ë™í˜„","ê¹€ìˆ˜ë¯¼","ê¹€ì–´ì§„","ê¹€ì¢…ë¹ˆ","ê¹€ì£¼í™˜","ê¹€ì¤€í˜","ê¹€íƒœí•˜","ë…¸ë‹¨ë¹„","ë¯¼í•œë¹›","ë°•ì‹œì€","ë°•ì¢…ìš°","ë³€í˜„ì •","ì†¡ì¬ë¯¼","ì´ì˜ˆë¦°","ì´ì€ì„œ","ì´í•´ì¸","ì´í˜„ì„œ","ì„ìŠ¬ë¹„","ì¥ì›ë¹ˆ","ì¥ì§€í˜œ","ìµœì€ì§„"]
};
const GRADES={"1í•™ë…„":["1","2","3"],"2í•™ë…„":["1","2","3"],"3í•™ë…„":["1","2","3"]};
const LS_ROSTERS="uniform_rosters", LS_SETTINGS="uniform_gh_settings";

/* ===== ìƒíƒœ ===== */
let state={grade:"2í•™ë…„",cls:"2-2",date:todayStr(),checks:{}};
/* ê¸°ì¡´ ë¡œì»¬ ë°ì´í„°ì™€ ê¸°ë³¸ ë°ì´í„°ë¥¼ ë³‘í•©(ëˆ„ë½ ë°˜ ìë™ ì¶”ê°€) */
const LS_RO = load(LS_ROSTERS);
let ROSTERS = LS_RO ? {...DEFAULT_ROSTERS, ...LS_RO} : {...DEFAULT_ROSTERS};
save(LS_ROSTERS, ROSTERS); // ë³‘í•©ë³¸ ì €ì¥(ì°¨í›„ì—ë„ ìœ ì§€)
let SETTINGS=load(LS_SETTINGS)||{owner:"",repo:"",branch:"main",base:"data",token:""};

/* ===== ìœ í‹¸ ===== */
function load(k){try{return JSON.parse(localStorage.getItem(k)||"")}catch{return null}}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
function todayStr(){const d=new Date();return d.toISOString().slice(0,10)}
function classKey(grade,ban){return `${grade.replace("í•™ë…„","")}-${ban}`}
function id(x){return document.getElementById(x)}
function ghHeaders(){const h={"Accept":"application/vnd.github+json"}; if(SETTINGS.token) h["Authorization"]=`Bearer ${SETTINGS.token}`; return h;}

/* ===== ìš”ì†Œ ===== */
const segGrade=id("seg-grade"), segClass=id("seg-class"), grid=id("grid");
const dateInput=id("dateInput"), summaryPill=id("summaryPill");
const searchInput=id("searchInput"); const btnAdd=id("btn-add"), btnEdit=id("btn-edit"), btnSaveOrder=id("btn-save-order");
const btnSelectAll=id("btn-select-all"), btnClear=id("btn-clear");
const btnPrint=id("btn-print"), btnSettings=id("btn-settings"), btnSaveGit=id("btn-save-github");
const modal=id("modal"), btnClose=id("btn-close"), btnSaveSettings=id("btn-save-settings"), btnResetSettings=id("btn-reset-settings"), btnWipeLocal=id("btn-wipe-local");
const ghOwner=id("ghOwner"), ghRepo=id("ghRepo"), ghBranch=id("ghBranch"), ghBase=id("ghBase"), ghToken=id("ghToken");
const rankModal=id("rankModal"), btnCloseRank=id("btn-close-rank"), rankBody=id("rankBody"), rankHint=id("rankHint");
const scopeSeg=id("scopeSeg"), gradeSeg=id("gradeSeg"), btnRefreshRank=id("btn-refresh-rank");

/* ===== ì´ˆê¸° ë Œë” ===== */
dateInput.value=state.date;
renderGrades(); renderClasses(); renderStudents(); updateSummary();

/* ===== ë Œë”/ì´ë²¤íŠ¸ ===== */
function renderGrades(){
  segGrade.innerHTML="";
  Object.keys(GRADES).forEach(g=>{
    const b=document.createElement("button");
    b.className="seg-btn"+(state.grade===g?" active":"");
    b.textContent=g;
    b.onclick=()=>{ state.grade=g;
      const bans=GRADES[g]; const curBan=state.cls.split("-")[1]; state.cls=classKey(g, bans.includes(curBan)?curBan:bans[0]);
      state.checks={}; renderGrades(); renderClasses(); renderStudents(); updateSummary();
    };
    segGrade.appendChild(b);
  });
}
function renderClasses(){
  segClass.innerHTML="";
  (GRADES[state.grade]||[]).forEach(b=>{
    const key=classKey(state.grade,b);
    const el=document.createElement("button");
    el.className="seg-btn"+(state.cls===key?" active":"");
    el.textContent=`${state.grade.replace("í•™ë…„","")}-${b}ë°˜`;
    el.onclick=()=>{ state.cls=key; state.checks={}; searchInput.value=""; renderClasses(); renderStudents(); updateSummary(); };
    segClass.appendChild(el);
  });
}
function renderStudents(){
  grid.innerHTML="";
  const roster=(ROSTERS[state.cls]||[]).slice();
  const q=searchInput.value.trim();
  const list=roster.map((name,i)=>({no:i+1,name,on:!!state.checks[name]})).filter(x=>!q || x.name.includes(q));

  list.forEach(({no,name,on},idx)=>{
    const wrap=document.createElement("div");
    wrap.className="student "+(on?"on":"off");

    // toggle only when not clicking inputs/buttons
    wrap.addEventListener("click",(e)=>{ if(e.target.closest("button, input")) return; state.checks[name]=!state.checks[name]; renderStudents(); updateSummary(); });

    const left=document.createElement("div");
    left.className="nm";

    if(btnEdit.dataset.on==="1"){
      const num=document.createElement("input"); num.type="number"; num.className="num"; num.min="1"; num.value=no; num.dataset.name=name;
      left.appendChild(num);
      const nm=document.createElement("span"); nm.textContent=name; left.appendChild(nm);

      const del=document.createElement("button"); del.className="del"; del.textContent="Ã—"; del.title="ì‚­ì œ";
      del.onclick=(e)=>{ e.stopPropagation(); if(!confirm(`${name} í•™ìƒì„ ì‚­ì œí• ê¹Œìš”?`)) return;
        const r=ROSTERS[state.cls].slice(); const i=r.indexOf(name); if(i>=0) r.splice(i,1); ROSTERS[state.cls]=r; save(LS_ROSTERS,ROSTERS); delete state.checks[name]; renderStudents(); updateSummary();
      };
      left.appendChild(del);
    } else {
      left.innerHTML=`<span class="muted" style="margin-right:8px">${no}ë²ˆ</span>${name}`;
    }

    wrap.appendChild(left);
    const right=document.createElement("div"); right.textContent = on? "âœ…":"âŒ"; wrap.appendChild(right);
    grid.appendChild(wrap);
  });

  // í¸ì§‘ ê´€ë ¨ ë²„íŠ¼ í‘œì‹œ
  btnSaveOrder.style.display = btnEdit.dataset.on==="1" ? "inline-block" : "none";
}
function updateSummary(){
  const roster=ROSTERS[state.cls]||[]; const onCount=Object.entries(state.checks).filter(([k,v])=>v && roster.includes(k)).length;
  summaryPill.textContent=`ì´ ${roster.length}ëª… Â· âœ… ${onCount}`;
}

/* ìƒë‹¨ ë²„íŠ¼ */
btnPrint.onclick=()=>window.print();
dateInput.onchange=()=>{ state.date=dateInput.value; };
searchInput.oninput=()=>renderStudents();
btnAdd.onclick=()=>{ const name=(searchInput.value||"").trim(); if(!name) return alert("ì¶”ê°€í•  í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”."); const r=ROSTERS[state.cls]||[]; if(r.includes(name)) return alert("ì´ë¯¸ ëª…ë‹¨ì— ìˆìŠµë‹ˆë‹¤."); r.push(name); ROSTERS[state.cls]=r; save(LS_ROSTERS,ROSTERS); searchInput.value=""; renderStudents(); updateSummary(); };
btnEdit.onclick=()=>{ const on=btnEdit.dataset.on==="1"; btnEdit.dataset.on=on?"0":"1"; btnEdit.textContent=on?"í¸ì§‘ ëª¨ë“œ":"í¸ì§‘ ì¢…ë£Œ"; renderStudents(); };
btnSaveOrder.onclick=()=>saveNumbers();
btnSelectAll.onclick=()=>{ (ROSTERS[state.cls]||[]).forEach(n=>state.checks[n]=true); renderStudents(); updateSummary(); };
btnClear.onclick=()=>{ state.checks={}; renderStudents(); updateSummary(); };

/* ===== ë²ˆí˜¸ ì €ì¥(ì¬ì •ë ¬) ===== */
function saveNumbers(){
  const inputs=[...document.querySelectorAll('.num')];
  if(!inputs.length) return;
  const rows=inputs.map((inp,idx)=>({name: inp.dataset.name, num: parseInt(inp.value||"0",10), oldIndex: idx}));
  rows.forEach(r=>{ if(!(r.num>0)) r.num=999; });
  rows.sort((a,b)=> a.num-b.num || a.oldIndex-b.oldIndex);
  ROSTERS[state.cls]=rows.map(r=>r.name);
  save(LS_ROSTERS,ROSTERS);
  renderStudents(); updateSummary();
  alert("ë²ˆí˜¸ê°€ ì €ì¥Â·ì¬ì •ë ¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
}

/* ===== ì„¤ì • ëª¨ë‹¬ & ë¡œì»¬ ì´ˆê¸°í™” ===== */
btnSettings.onclick=()=>{ ghOwner.value=SETTINGS.owner||""; ghRepo.value=SETTINGS.repo||""; ghBranch.value=SETTINGS.branch||"main"; ghBase.value=SETTINGS.base||"data"; ghToken.value=SETTINGS.token||""; modal.classList.add("show"); };
btnClose.onclick=()=>modal.classList.remove("show");
btnSaveSettings.onclick=()=>{ SETTINGS={owner:ghOwner.value.trim(),repo:ghRepo.value.trim(),branch:ghBranch.value.trim()||"main",base:ghBase.value.trim()||"data",token:ghToken.value.trim()}; save(LS_SETTINGS,SETTINGS); modal.classList.remove("show"); alert("ì„¤ì • ì €ì¥ë¨"); };
btnResetSettings.onclick=()=>{ SETTINGS={owner:"",repo:"",branch:"main",base:"data",token:""}; save(LS_SETTINGS,SETTINGS); ghOwner.value=ghRepo.value=ghToken.value=""; alert("ì„¤ì • ì´ˆê¸°í™”ë¨"); };
btnWipeLocal.onclick=()=>{ if(!confirm("ë¡œì»¬ ì €ì¥ëœ ëª…ë‹¨/ì²´í¬ ë°ì´í„°ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í• ê¹Œìš”?")) return; localStorage.removeItem(LS_ROSTERS); state.checks={}; ROSTERS={...DEFAULT_ROSTERS}; save(LS_ROSTERS,ROSTERS); renderGrades(); renderClasses(); renderStudents(); updateSummary(); alert("ë¡œì»¬ ë°ì´í„° ì´ˆê¸°í™” ì™„ë£Œ"); };

/* ===== GitHub ì €ì¥(ë²„íŠ¼ í•˜ë‚˜) ===== */
btnSaveGit.onclick=saveToGitHub;
async function saveToGitHub(){
  const {owner,repo,branch,base,token}=SETTINGS;
  if(!owner||!repo||!token){ alert("âš™ï¸ ì €ì¥ì†Œ ì„¤ì •ì„ ë¨¼ì € ì™„ë£Œí•˜ì„¸ìš”."); return; }
  const payload=buildPayload();
  const path=`${base}/${payload.date}/${payload.class}.json`;
  const url=`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
  let sha;
  const get=await fetch(`${url}?ref=${encodeURIComponent(branch)}`,{headers:ghHeaders()});
  if(get.status===200){ sha=(await get.json()).sha; }
  const content=btoa(unescape(encodeURIComponent(JSON.stringify(payload,null,2))));
  const res=await fetch(url,{method:"PUT",headers:{...ghHeaders(),"Content-Type":"application/json"},body:JSON.stringify({message:`Uniform check: ${payload.date} ${payload.class}`,content,branch,sha})});
  if(res.ok){ alert("GitHub ì €ì¥ ì„±ê³µ"); } else { alert("ì €ì¥ ì‹¤íŒ¨: "+await res.text()); }
}
function buildPayload(){
  const roster=ROSTERS[state.cls]||[];
  const items=roster.map((n,i)=>({no:i+1,name:n,worn:!!state.checks[n]}));
  const worn=items.filter(x=>x.worn).length;
  return {date:state.date,class:state.cls,total:roster.length,worn,rate:roster.length?Math.round(100*worn/roster.length):0,items};
}

/* ===== ëˆ„ì  ìˆœìœ„(ì „ì²´/í•™ë…„ë³„) â€“ GitHubì—ì„œ ì§‘ê³„ ===== */
document.getElementById("btn-ranking").onclick=async()=>{ rankBody.innerHTML=""; rankHint.textContent=""; rankModal.classList.add("show"); setScope('all'); await buildRankingFromGitHub('all', null); };
btnCloseRank.onclick=()=>rankModal.classList.remove("show");
scopeSeg.addEventListener("click",async(e)=>{ if(e.target.tagName!=="BUTTON") return; [...scopeSeg.children].forEach(b=>b.classList.remove("active")); e.target.classList.add("active"); const sc=e.target.dataset.scope; setScope(sc); const gradeBtn=[...gradeSeg.children].find(b=>b.classList.contains("active")); const grade=gradeBtn?gradeBtn.dataset.grade:null; await buildRankingFromGitHub(sc, sc==='grade'?grade:null); });
gradeSeg.addEventListener("click",async(e)=>{ if(e.target.tagName!=="BUTTON") return; [...gradeSeg.children].forEach(b=>b.classList.remove("active")); e.target.classList.add("active"); const grade=e.target.dataset.grade; await buildRankingFromGitHub('grade', grade); });
btnRefreshRank.onclick=async()=>{ const sc=[...scopeSeg.children].find(b=>b.classList.contains("active")).dataset.scope; const gradeBtn=[...gradeSeg.children].find(b=>b.classList.contains("active")); const grade=gradeBtn?gradeBtn.dataset.grade:null; await buildRankingFromGitHub(sc, sc==='grade'?grade:null); };

function setScope(sc){ gradeSeg.style.display = (sc==="grade") ? "inline-flex" : "none"; }

async function buildRankingFromGitHub(scope, grade){
  const {owner,repo,branch,base}=SETTINGS;
  if(!owner||!repo){ rankHint.textContent="âš™ï¸ ì €ì¥ì†Œ ì„¤ì • í›„ ì´ìš©í•˜ì„¸ìš”."; return; }
  rankBody.innerHTML=""; rankHint.textContent="ì§‘ê³„ ì¤‘...";
  // ë¸Œëœì¹˜ íŠ¸ë¦¬
  const b=await fetch(`https://api.github.com/repos/${owner}/${repo}/branches/${encodeURIComponent(branch||"main")}`,{headers:ghHeaders()});
  if(!b.ok){ rankHint.textContent="ë¸Œëœì¹˜ ì¡°íšŒ ì‹¤íŒ¨"; return; }
  const sha=(await b.json()).commit?.sha;
  const t=await fetch(`https://api.github.com/repos/${owner}/${repo}/git/trees/${sha}?recursive=1`,{headers:ghHeaders()});
  if(!t.ok){ rankHint.textContent="íŒŒì¼ íŠ¸ë¦¬ ì¡°íšŒ ì‹¤íŒ¨"; return; }
  const list=(await t.json()).tree||[];
  const prefix=`${base||"data"}/`;
  const blobs=list.filter(n=>n.type==="blob" && n.path.startsWith(prefix) && n.path.endsWith(".json"));
  const counts={}; // key: "í•™ë…„-ë°˜|ì´ë¦„"
  const inGrade=(cls)=>{ if(!grade) return true; return cls.startsWith(grade.replace("í•™ë…„","")); };
  for(const n of blobs){
    const raw=`https://raw.githubusercontent.com/${owner}/${repo}/${encodeURIComponent(branch||"main")}/${n.path}`;
    const j=await (await fetch(raw)).json().catch(()=>null); if(!j||!j.items||!j.class) continue;
    if(scope==="grade" && !inGrade(j.class)) continue;
    const cls=j.class; j.items.forEach(it=>{ if(it.worn){ const key=`${cls}|${it.name}`; counts[key]=(counts[key]||0)+1; }});
  }
  const arr=Object.entries(counts).map(([key,c])=>{ const [cls,name]=key.split("|"); return {cls,name,count:c}; });
  arr.sort((a,b)=> b.count-a.count || a.cls.localeCompare(b.cls,"ko") || a.name.localeCompare(b.name,"ko"));
  let rank=0, prev=null; arr.forEach((r,i)=>{ if(prev===null || r.count<prev){ rank=i+1; prev=r.count;} r.rank=rank; });
  rankBody.innerHTML=""; arr.forEach(r=>{ const tr=document.createElement("tr"); tr.innerHTML=`<td>${r.rank}</td><td><span class="muted">${r.cls}</span> ${r.name}</td><td>${r.count}</td>`; rankBody.appendChild(tr); });
  rankHint.textContent = `ì´ ${arr.length}ëª… ì§‘ê³„ë¨ Â· ë²”ìœ„: ${scope==="all"?"ì „ì²´":grade}`;
}
</script>
</body>
</html>
