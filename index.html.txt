<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>êµë³µ ì°©ìš© ì²´í¬ â€“ ì‚¬ì§„Â·ì°¨íŠ¸Â·í•™ë…„ í†µê³„(ë‹¨ì¼ íŒŒì¼)</title>
<!-- Chart.js (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root {
    --bg: #f6f8fb; --card:#fff; --text:#0f172a; --muted:#64748b;
    --brand:#2563eb; --brand2:#1d4ed8; --ok:#16a34a; --no:#ef4444;
    --ring: rgba(37,99,235,.18); --shadow:0 10px 24px rgba(15,23,42,.06); --radius:16px;
  }
  html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,"Apple SD Gothic Neo","Noto Sans KR",Segoe UI,Roboto,Helvetica,Arial}
  .container{max-width:1180px;margin:22px auto 80px;padding:0 16px}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow)}
  .header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 18px}
  .title{display:flex;align-items:center;gap:10px;font-weight:800}
  .title .badge{font-size:22px}
  .muted{color:var(--muted)}
  .section{padding:16px 18px;border-top:1px solid #edf2f7}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .btn{appearance:none;border:1px solid #e5e7eb;background:#fff;color:var(--text);
    padding:9px 14px;border-radius:12px;cursor:pointer;font-weight:700;transition:.15s ease}
  .btn:hover{transform:translateY(-1px);border-color:#d1d5db}
  .btn.brand{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn.brand:hover{background:var(--brand2)}
  .btn.ghost{background:transparent}
  .btn.small{padding:6px 10px;border-radius:10px}
  input[type="date"],select,input[type="text"]{border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;outline:0}
  input[type="date"]:focus,select:focus,input[type="text"]:focus{border-color:var(--brand);box-shadow:0 0 0 4px var(--ring)}
  .seg{display:inline-flex;background:#eef2ff;border-radius:12px;padding:4px}
  .seg .seg-btn{border:0;background:transparent;padding:7px 12px;border-radius:10px;cursor:pointer;font-weight:800;color:#334155}
  .seg .seg-btn.active{background:#fff;box-shadow:var(--shadow);color:#1d4ed8}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  @media (min-width:720px){.grid{grid-template-columns:repeat(4,minmax(0,1fr))}}
  .student{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 12px;border:1px solid #e5e7eb;border-radius:14px;background:#fff;cursor:pointer}
  .student:hover{transform:translateY(-1px)}
  .student.on{border-color:rgba(22,163,74,.25);background:rgba(22,163,74,.06)}
  .student.off{border-color:rgba(239,68,68,.22);background:rgba(239,68,68,.05)}
  .name{font-weight:800}
  .state{font-size:18px}
  .thumb{width:44px;height:44px;border-radius:12px;object-fit:cover;background:#f1f5f9;border:1px solid #e5e7eb}
  .avatar{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#e2e8f0,#f8fafc);font-weight:900;color:#334155;border:1px solid #e5e7eb}
  .del{display:inline-flex;width:22px;height:22px;border-radius:50%;align-items:center;justify-content:center;background:#fee2e2;color:#b91c1c;margin-left:8px;font-weight:900}
  .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .pill{display:inline-flex;gap:6px;align-items:center;background:#f1f5f9;color:#0f172a;padding:6px 10px;border-radius:9999px;font-weight:800}
  .divider{height:1px;background:#edf2f7;margin:10px 0}
  .right{margin-left:auto}
  .hidden{display:none !important}
  .footer{font-size:13px}
  /* modal */
  .modal{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;padding:18px}
  .modal.show{display:flex}
  .modal .box{background:#fff;border-radius:16px;width:100%;max-width:680px;box-shadow:var(--shadow)}
  .modal .box .hd{padding:14px 16px;border-bottom:1px solid #eef2f7;display:flex;align-items:center;justify-content:space-between}
  .modal .box .bd{padding:16px}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid #e5e7eb;padding:10px 8px;text-align:left}
  .table th{background:#f8fafc}
  .printable{padding:12px 16px}
  .warn{color:#b91c1c;font-weight:700}
  @media print {.no-print{display:none!important} body{background:#fff}.card{box-shadow:none}.printable{padding:0}}
  .disabled{opacity:.6; pointer-events:none}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="header">
      <div class="title"><span class="badge">ğŸ§¥</span><span>êµë³µ ì°©ìš© ì²´í¬</span></div>
      <div class="row no-print">
        <span id="modePill" class="pill">ğŸ”“ ì½ê¸° ëª¨ë“œ</span>
        <button class="btn small" id="btn-teacher">ğŸ”’ êµì‚¬ ëª¨ë“œ</button>
        <button class="btn small" id="btn-settings">âš™ï¸ ì„¤ì •</button>
        <button class="btn small" id="btn-print">ğŸ–¨ï¸ ì¸ì‡„</button>
        <a class="btn small ghost" href="https://gptonline.ai/ko/" target="_blank" rel="noopener">í•œêµ­í˜• GPT</a>
      </div>
    </div>

    <!-- ìƒë‹¨ ì»¨íŠ¸ë¡¤ -->
    <div class="section">
      <div class="row controls">
        <label>ë‚ ì§œ</label><input type="date" id="dateInput">
        <span class="pill" id="summaryPill">ì´ 0ëª… Â· âœ… 0</span>
        <div class="right no-print">
          <button class="btn small" id="btn-download">ğŸ’¾ JSON ì €ì¥</button>
          <button class="btn small brand" id="btn-save-github">â¬†ï¸ GitHub ì €ì¥</button>
        </div>
      </div>
    </div>

    <!-- í•™ë…„/ë°˜ ë²„íŠ¼ + ê²€ìƒ‰/í¸ì§‘ -->
    <div class="section">
      <div class="row" style="justify-content:space-between;gap:8px">
        <div class="seg no-print" id="seg-grade"></div>
        <div class="seg no-print" id="seg-class"></div>
        <div class="controls no-print">
          <input type="text" id="searchInput" placeholder="í•™ìƒ ì´ë¦„ ê²€ìƒ‰" style="min-width:180px">
          <label class="row" style="gap:6px"><input type="checkbox" id="ckOnlyChecked"><span class="muted">âœ…ë§Œ</span></label>
          <button class="btn small" id="btn-add">í•™ìƒ ì¶”ê°€</button>
          <button class="btn small" id="btn-edit">í¸ì§‘ ëª¨ë“œ</button>
          <button class="btn small" id="btn-select-all">ì „ì²´ ì„ íƒ</button>
          <button class="btn small" id="btn-clear">ì „ì²´ í•´ì œ</button>
          <button class="btn small" id="btn-photo-bulk">ğŸ“· ì¼ê´„ ì—…ë¡œë“œ</button>
          <button class="btn small" id="btn-photo-clear">ğŸ§¹ ì‚¬ì§„ ëª¨ë‘ ì œê±°</button>
          <input type="file" id="file-photo-bulk" class="hidden" accept="image/*" multiple>
        </div>
      </div>
      <div class="divider"></div>
      <div class="grid printable" id="studentsGrid"></div>
    </div>

    <!-- ì›”ë³„ í†µê³„(ë°˜) -->
    <div class="section no-print">
      <div class="row" style="justify-content:space-between;gap:8px">
        <div class="row" style="gap:12px">
          <strong>ğŸ“Š ì›”ë³„ í†µê³„ â€“ í˜„ì¬ ë°˜</strong>
          <input type="month" id="monthInput">
        </div>
        <div class="row">
          <button class="btn small" id="btn-stat-local">ë¡œì»¬ì—ì„œ ê³„ì‚°</button>
          <button class="btn small" id="btn-stat-github">GitHubì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button class="btn small" id="btn-stat-csv">CSVë¡œ ë‚´ë³´ë‚´ê¸°</button>
        </div>
      </div>
      <div class="divider"></div>
      <div class="row" style="gap:18px;align-items:flex-start">
        <div style="flex:1;min-width:320px"><canvas id="chartClass" height="140"></canvas></div>
        <div style="flex:1;min-width:320px;overflow:auto">
          <table class="table" id="statTable">
            <thead><tr><th>ë²ˆí˜¸</th><th>ì´ë¦„</th><th>ì›” ëˆ„ì (âœ…)</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- í•™ë…„ ì „ì²´ í†µê³„ -->
    <div class="section">
      <div class="row" style="justify-content:space-between;gap:8px">
        <div class="row" style="gap:12px">
          <strong>ğŸ« í•™ë…„ ì „ì²´ í†µê³„</strong>
          <span id="gradeLabel" class="pill">1í•™ë…„</span>
          <input type="month" id="gradeMonthInput">
        </div>
        <div class="row no-print">
          <button class="btn small" id="btn-grade-local">ë¡œì»¬ì—ì„œ ê³„ì‚°</button>
          <button class="btn small" id="btn-grade-github">GitHubì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button class="btn small" id="btn-grade-csv">CSVë¡œ ë‚´ë³´ë‚´ê¸°</button>
        </div>
      </div>
      <div class="divider"></div>
      <div class="row" style="gap:18px;align-items:flex-start">
        <div style="flex:1;min-width:320px"><canvas id="chartGrade" height="140"></canvas></div>
        <div style="flex:1;min-width:320px;overflow:auto">
          <table class="table" id="gradeTable">
            <thead><tr><th>ë°˜</th><th>íŒŒì¼ ìˆ˜(ì¼ìˆ˜)</th><th>ì›” ëˆ„ì (âœ… í•©ê³„)</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="section footer">
      <span class="muted">â€» ê¸°ë³¸ì€ ê³µê°œ ì½ê¸° ì „ìš©. ğŸ”’êµì‚¬ ëª¨ë“œì—ì„œë§Œ ì²´í¬/í¸ì§‘/ì €ì¥ì´ ê°€ëŠ¥í•˜ë©°, GitHub ì €ì¥ì—ëŠ” PATì´ í•„ìš”í•©ë‹ˆë‹¤.</span>
    </div>
  </div>
</div>

<!-- ì„¤ì • ëª¨ë‹¬ -->
<div class="modal" id="modal">
  <div class="box">
    <div class="hd">
      <strong>ì €ì¥ì†Œ/ë³´í˜¸ ì„¤ì •</strong>
      <button class="btn small" id="btn-close-modal">ë‹«ê¸°</button>
    </div>
    <div class="bd">
      <div class="row" style="gap:14px;margin-bottom:10px"><label style="min-width:160px">GitHub Owner</label><input type="text" id="ghOwner" placeholder="e.g. your-id" style="flex:1"></div>
      <div class="row" style="gap:14px;margin-bottom:10px"><label style="min-width:160px">Repository</label><input type="text" id="ghRepo" placeholder="e.g. uniform-checker-data" style="flex:1"></div>
      <div class="row" style="gap:14px;margin-bottom:10px"><label style="min-width:160px">Branch</label><input type="text" id="ghBranch" value="main" style="flex:1"></div>
      <div class="row" style="gap:14px;margin-bottom:10px"><label style="min-width:160px">Base Path</label><input type="text" id="ghBase" value="data" style="flex:1"></div>
      <div class="row" style="gap:14px;margin-bottom:10px"><label style="min-width:160px">Personal Access Token</label><input type="password" id="ghToken" placeholder="ghp_..." style="flex:1"></div>
      <div class="row" style="gap:14px;margin:16px 0"><label style="min-width:160px">êµì‚¬ ëª¨ë“œ PIN (ì„ íƒ)</label><input type="password" id="teacherPin" placeholder="ì„¤ì • ì‹œ í•„ìš”" style="flex:1"></div>
      <div class="row">
        <button class="btn small brand" id="btn-save-settings">ì„¤ì • ì €ì¥</button>
        <button class="btn small" id="btn-reset-settings">ì„¤ì • ì´ˆê¸°í™”</button>
        <span class="muted">â€» fine-grained í† í° + <span style="font-family:ui-monospace">contents:write</span> ê¶Œì¥</span>
      </div>
      <div class="row" style="margin-top:10px">
        <span class="warn">PINì€ ê°„ë‹¨í•œ ë³´í˜¸ ìˆ˜ë‹¨ì¼ ë¿, ë³´ì•ˆ ê¸°ëŠ¥ì´ ì•„ë‹™ë‹ˆë‹¤.</span>
      </div>
    </div>
  </div>
</div>

<script>
/* ====================== ê¸°ë³¸ ë°ì´í„° ====================== */
const DEFAULT_ROSTERS = {
  "1-1":["ê³ ìˆ˜ë¯¼","êµ¬ì£¼ì˜","ê¸¸ì„ ìˆ˜","ê¹€ê°€ì›","ê¹€ë‹¤í•¨","ê¹€ìˆ˜ë¹ˆ","ê¹€íƒœì„","ê¹€íƒœí¬","ê¹€í•˜ì€","ë¬¸ì§€ë¯¼","ë°•ì„ ì›…","ë°•ì†Œì˜","ì†¡ê±´ì˜","ìœ¤ëŒ€ì›","ìœ¤í˜„ìš°","ì´ê°€ë¹ˆ","ì´ìˆ˜í˜„","ì´ì •ë¯¼","ì •ì§€ìš°","ì •ì°¬ìš©","ì§€ì˜ë¯¼","í™©ê°€ì˜¨"],
  "1-2":["ê³µë³‘í˜¸","ê¸¸ë¹ˆë‚˜","ê¹€ì˜ë¯¼","ê¹€í•˜ìœ¤","ë°•ë²”êµ­","ì‹ ê´€ìš°","ìš©ìˆ˜ë¹ˆ","ìœ¤íƒœí¬","ì´ë‚˜ê²½","ì´ë¯¼ì£¼","ì´ìœ¤ì•„","ì´ì •í›ˆ","ì„ì„œí›„","ì„ì¤€ìš°","ì¥ì„œì—°","ì¥ì§€í›ˆ","ì „ì‚¬ëª…","ì „ìƒë¯¼","ì¡°ì€","ì£¼ì†”ë¹ˆ","ì§€ìˆ˜ì—°","ìµœì§€ìœ ","í•œë™í•˜"],
  "1-3":["ê°•ì§€í˜¸","ê¹€ë¯¼ì •","ê¹€ìƒìš±","ê¹€ìš©ì‹","ê¹€ì£¼í˜„","ê¹€ì§€í™˜","ê¹€íš¨ì¸","ë°•ì„œì—°","ë°•ì€ë¹ˆ","ë°•ì°¬ì¤€","ë°±ì„±í˜„","ì‹ ì†Œì—°","ì‹¬í˜„ë¥ ","ì•ˆì˜ˆì§„","ì•ˆì§€ì˜","ì˜¤ìœ ì¤€","ìœ¤ê°•ì‚°","ìœ¤ì„¸ì˜","ìœ¤ì‹œí›„","ì´ìˆ˜ì•„","ì •ì˜ˆì„œ","í•œì§€ë¯¼","ë‚¨ê¶ë™í™˜"],
  "2-1":["ê³ ì€í˜œ","êµ¬ìŠ¹ëª¨","ê¹€ë‚˜ê²½","ê¹€ì¤€í˜¸","ê¹€ì±„ë¯¼","ê¹€í˜„ë¹ˆ","ê¹€í¬ì„œ","ë„ê°€ì˜","ë¯¼ìˆ˜ì—°","ë°•ì˜ˆì†”","ë°•ì§€í™","ì†¡ì§„ì„±","ì´ìŠ¬ë¹„","ì´ì£¼í˜„","ì´ì¤€í˜","ì´ì²­í•˜","ì´í˜•ì§„","ì¡°ë¯¼ì„œ","ì¡°ìœ ë¹ˆ","ì¡°ì€ì°¬","í•˜ìŠ¹í˜¸"],
  "2-3":["ê¸¸ê²½ë¦¼","ê¸¸ë‚˜ì—°","ê¸¸í˜œë¯¸","ê¹€ê°€ì€","ê¹€ìš°ì² ","ê¹€ì›í˜¸","ê¹€ì§€ìš°","ê¹€íš¨ìš°","ë°•ì§„ì—½","ì†ë¯¼ì •","ì•ˆì˜ˆì›","ì–‘í¬ë°±","ì˜¤ì§€ìœ ","ìš©í•˜ì€","ìœ ì˜¨ìœ ","ìœ ì¬ì›…","ì´ìœ ë¹ˆ","ì´ì°¨ìœ¤","ì •ë¯¼ì¤€","ì¡°ì¸ì„­","ìµœê°€ì¸","ìµœì†Œì˜","í•œì§€ì˜","í˜„ì§€ì„±"],
  "3-1":["ê³ ê²½ë¯¼","ê¹€ê·œì—°","ê¹€ë³´í›ˆ","ê¹€ì„ ìš°","ê¹€ì‹œì€","ê¹€ì°¬í˜„","ê¹€íš¨ì •","ë°•ì˜ìš±","ë°•ìœ¤ì„±","ë°•ì§€ìš°","ë°±ì„œí˜„","ì†¡ì •í™˜","ì´ì„œìœ¤","ì´ì„œí˜„","ì´ìœ ì¤€","ì´ì€ë¹„","ì´ì€ì§„","ì´í•˜ì˜","ì¥ìˆ˜ë¯¼","ì •ì¬ì—­","ì¡°ì¤‘í˜„","ìµœìœ¤ì„œ","ìµœí¬ìˆ˜"],
  "3-2":["ê¹€ë‹¨ì˜¤","ê¹€ë¯¼ì—½","ê¹€ìœ ë‚˜","ê¹€ì¬ì›","ê¹€í˜¸ì—°","ë‚¨ëŒ€í˜¸","ë°•ì°¬í˜„","ë³µì„ ì˜","ì†ì§€ë¯¼","ì‹ ê°€ì›","ì—„ì†Œìœ¨","ì˜¤ì±„í˜„","ìš©í˜„ë¹ˆ","ìš°ë‹¤ì—°","ìœ ìˆ˜ì—°","ì´ì„œì›","ì´ì€ìš°","ì¥ì„œì§„","ì¥ìˆ˜ë¯¼","ì¥ì˜ë¯¼","ì •ì‹œì—°","ì •ì§€ë¯¼","ì£¼ê°€ì˜"],
  "3-3":["ê°•íƒœì´","ê¹€ë™ì—°","ê¹€ë™í˜„","ê¹€ìˆ˜ë¯¼","ê¹€ì–´ì§„","ê¹€ì¢…ë¹ˆ","ê¹€ì£¼í™˜","ê¹€ì¤€í˜","ê¹€íƒœí•˜","ë…¸ë‹¨ë¹„","ë¯¼í•œë¹›","ë°•ì‹œì€","ë°•ì¢…ìš°","ë³€í˜„ì •","ì†¡ì¬ë¯¼","ì´ì˜ˆë¦°","ì´ì€ì„œ","ì´í•´ì¸","ì´í˜„ì„œ","ì„ìŠ¬ë¹„","ì¥ì›ë¹ˆ","ì¥ì§€í˜œ","ìµœì€ì§„"]
};
const GRADES = {"1í•™ë…„":["1","2","3"], "2í•™ë…„":["1","3"], "3í•™ë…„":["1","2","3"]};
const LS_ROSTERS="uniform_rosters", LS_SETTINGS="uniform_gh_settings", LS_LOGS="uniform_logs", LS_PHOTOS="uniform_photos", LS_PIN="uniform_teacher_pin";

/* ====================== ìƒíƒœ ====================== */
let state = {
  grade: "1í•™ë…„", cls: "1-1", date: todayStr(),
  editMode: false, filterText: "", onlyChecked: false, checks: {}, teacherMode: false
};
let ROSTERS = load(LS_ROSTERS) || {...DEFAULT_ROSTERS};
let PHOTOS = load(LS_PHOTOS) || {}; // { "1-1": { "í™ê¸¸ë™": dataUrl } }
let SETTINGS = load(LS_SETTINGS) || {owner:"",repo:"",branch:"main",base:"data",token:""};
let TEACHER_PIN = localStorage.getItem(LS_PIN) || "";

/* ====================== ë„ìš°ë¯¸ ====================== */
function load(k){try{return JSON.parse(localStorage.getItem(k)||"")}catch{ return null }}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
function classKey(grade,ban){return `${grade.replace("í•™ë…„","")}-${ban}`}
function rosterFor(cls){return ROSTERS[cls]||[]}
function getPhoto(cls,name){return (PHOTOS[cls]&&PHOTOS[cls][name])||null}
function setPhoto(cls,name,dataUrl){PHOTOS[cls]=PHOTOS[cls]||{};PHOTOS[cls][name]=dataUrl;save(LS_PHOTOS,PHOTOS)}
function clearPhotos(cls){if(PHOTOS[cls]){delete PHOTOS[cls];save(LS_PHOTOS,PHOTOS)}}
function todayStr(){const d=new Date();return d.toISOString().slice(0,10)}
function monthStr(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`}
function byId(id){return document.getElementById(id)}
function setDisabled(el,disabled){ if(disabled) el.classList.add("disabled"); else el.classList.remove("disabled"); el.disabled=!!disabled; }

/* ====================== ìš”ì†Œ ë°”ì¸ë”© ====================== */
const segGrade = byId("seg-grade"), segClass = byId("seg-class"), grid = byId("studentsGrid");
const summaryPill = byId("summaryPill"), dateInput = byId("dateInput");
const searchInput = byId("searchInput"), ckOnlyChecked = byId("ckOnlyChecked");
const btnAdd = byId("btn-add");
const btnEdit = byId("btn-edit"), btnSelectAll = byId("btn-select-all"), btnClear=byId("btn-clear");
const btnDownload = byId("btn-download"), btnSaveGh=byId("btn-save-github"), btnPrint=byId("btn-print");
const btnPhotoBulk=byId("btn-photo-bulk"), filePhotoBulk=byId("file-photo-bulk"), btnPhotoClear=byId("btn-photo-clear");
const monthInput=byId("monthInput"), statTable=byId("statTable").querySelector("tbody");
const btnStatLocal=byId("btn-stat-local"), btnStatGithub=byId("btn-stat-github"), btnStatCsv=byId("btn-stat-csv");
const gradeLabel=byId("gradeLabel"), gradeMonthInput=byId("gradeMonthInput");
const btnGradeLocal=byId("btn-grade-local"), btnGradeGithub=byId("btn-grade-github"), btnGradeCsv=byId("btn-grade-csv");
const chartClassCtx=byId("chartClass").getContext("2d"), chartGradeCtx=byId("chartGrade").getContext("2d");
const modePill = byId("modePill"), btnTeacher = byId("btn-teacher");
let chartClass, chartGrade;

/* ====================== UI ë Œë” ====================== */
dateInput.value = state.date; monthInput.value = monthStr(new Date()); gradeMonthInput.value = monthStr(new Date());
renderGrades(); renderClasses(); renderStudents(); updateGradeLabel(); updateModeUI();

function renderGrades(){
  segGrade.innerHTML=""; Object.keys(GRADES).forEach(g=>{
    const b=document.createElement("button");
    b.className="seg-btn"+(state.grade===g?" active":""); b.textContent=g;
    b.onclick=()=>{ state.grade=g; if(!GRADES[g].includes(state.cls.split("-")[1])) state.cls=classKey(g,GRADES[g][0]); else state.cls=classKey(g,state.cls.split("-")[1]); state.checks={}; renderGrades(); renderClasses(); renderStudents(); updateGradeLabel(); };
    segGrade.appendChild(b);
  });
}
function renderClasses(){
  segClass.innerHTML=""; (GRADES[state.grade]||[]).forEach(ban=>{
    const key=classKey(state.grade,ban);
    const b=document.createElement("button");
    b.className="seg-btn"+(state.cls===key?" active":""); b.textContent=`${state.grade.replace("í•™ë…„","")}-${ban}ë°˜`;
    b.onclick=()=>{ state.cls=key; state.checks={}; renderClasses(); renderStudents(); };
    segClass.appendChild(b);
  });
}
function renderStudents(){
  grid.innerHTML=""; const roster = rosterFor(state.cls);
  const q=state.filterText.trim();
  const items = roster.map((n,i)=>({no:i+1,name:n,on:!!state.checks[n]}))
    .filter(x=>!q || x.name.includes(q)).filter(x=>!state.onlyChecked || x.on);
  const total = roster.length, onCount = Object.values(state.checks).filter(Boolean).length;
  summaryPill.textContent = `ì´ ${total}ëª… Â· âœ… ${onCount}`;

  items.forEach(({no,name,on})=>{
    const div=document.createElement("div"); div.className="student "+(on?"on":"off")+(state.editMode?" edit":"");
    div.onclick=()=>{ if(!state.teacherMode) return alert("êµì‚¬ ëª¨ë“œì—ì„œë§Œ ì²´í¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); if(state.editMode) return; state.checks[name]=!state.checks[name]; renderStudents(); };

    const left=document.createElement("div"); left.style.display="flex"; left.style.alignItems="center"; left.style.gap="10px";
    const imgUrl = getPhoto(state.cls,name);
    let thumb; if(imgUrl){ thumb=document.createElement("img"); thumb.className="thumb"; thumb.src=imgUrl; }
    else { thumb=document.createElement("div"); thumb.className="avatar"; thumb.textContent=(name[0]||"?"); }
    left.appendChild(thumb);

    const nm=document.createElement("div"); nm.className="name"; nm.innerHTML=`<span class="muted" style="margin-right:8px">${no}ë²ˆ</span>${name}`;
    left.appendChild(nm);

    if(state.editMode && state.teacherMode){
      const del=document.createElement("span"); del.className="del"; del.title="ì‚­ì œ"; del.textContent="Ã—";
      del.onclick=(e)=>{ e.stopPropagation(); if(!confirm(`${name} í•™ìƒì„ ì‚­ì œí• ê¹Œìš”?`)) return;
        const r=rosterFor(state.cls).slice(); const idx=r.indexOf(name); if(idx>=0) r.splice(idx,1);
        ROSTERS[state.cls]=r; save(LS_ROSTERS,ROSTERS); delete state.checks[name];
        if(PHOTOS[state.cls] && PHOTOS[state.cls][name]) { delete PHOTOS[state.cls][name]; save(LS_PHOTOS,PHOTOS); }
        renderStudents(); };
      left.appendChild(del);

      const cam=document.createElement("button"); cam.className="btn small"; cam.textContent="ğŸ“· ì‚¬ì§„"; cam.style.marginLeft="6px";
      cam.onclick=async(e)=>{ e.stopPropagation(); const file = await pickImage(); if(!file) return; const dataUrl = await toThumb(file, 180); setPhoto(state.cls,name,dataUrl); renderStudents(); };
      left.appendChild(cam);
    }

    const right=document.createElement("div"); right.className="state"; right.textContent = on? "âœ…":"âŒ";
    div.appendChild(left); div.appendChild(right); grid.appendChild(div);
  });
}
function updateGradeLabel(){ gradeLabel.textContent = state.grade; }
function updateModeUI(){
  modePill.textContent = state.teacherMode ? "ğŸ” êµì‚¬ ëª¨ë“œ" : "ğŸ”“ ì½ê¸° ëª¨ë“œ";
  setDisabled(btnAdd, !state.teacherMode);
  setDisabled(btnEdit, !state.teacherMode);
  setDisabled(btnSelectAll, !state.teacherMode);
  setDisabled(btnClear, !state.teacherMode);
  setDisabled(btnPhotoBulk, !state.teacherMode);
  setDisabled(btnPhotoClear, !state.teacherMode);
  setDisabled(btnSaveGh, !state.teacherMode);
}

/* ====================== ì´ë²¤íŠ¸ ====================== */
byId("btn-settings").onclick=()=>openSettings(); btnPrint.onclick=()=>window.print();
dateInput.onchange=()=>{ state.date=dateInput.value; };
searchInput.oninput=()=>{ state.filterText=searchInput.value; renderStudents(); };
ckOnlyChecked.onchange=()=>{ state.onlyChecked=ckOnlyChecked.checked; renderStudents(); };

btnTeacher.onclick=()=>{
  if(state.teacherMode){
    if(confirm("êµì‚¬ ëª¨ë“œë¥¼ ì¢…ë£Œí• ê¹Œìš”?")){ state.teacherMode=false; state.editMode=false; btnEdit.textContent="í¸ì§‘ ëª¨ë“œ"; updateModeUI(); renderStudents(); }
    return;
  }
  if(TEACHER_PIN){
    const given = prompt("êµì‚¬ ëª¨ë“œ PINì„ ì…ë ¥í•˜ì„¸ìš”:");
    if(given===null) return;
    if(given===TEACHER_PIN){ state.teacherMode=true; updateModeUI(); alert("êµì‚¬ ëª¨ë“œ í™œì„±í™”"); }
    else alert("PINì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
  } else {
    if(confirm("PINì´ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. êµì‚¬ ëª¨ë“œë¥¼ í™œì„±í™”í• ê¹Œìš”?")){ state.teacherMode=true; updateModeUI(); }
  }
};

btnAdd.onclick=()=>{ if(!state.teacherMode) return alert("êµì‚¬ ëª¨ë“œì—ì„œë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
  const name=(searchInput.value||"").trim();
  if(!name) return alert("ì¶”ê°€í•  í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
  const r=rosterFor(state.cls).slice();
  if(r.includes(name)) return alert("ì´ë¯¸ ëª…ë‹¨ì— ìˆìŠµë‹ˆë‹¤.");
  r.push(name); ROSTERS[state.cls]=r; save(LS_ROSTERS,ROSTERS); searchInput.value=""; state.filterText=""; renderStudents();
};
searchInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter") btnAdd.click(); });

btnEdit.onclick=()=>{ if(!state.teacherMode) return alert("êµì‚¬ ëª¨ë“œì—ì„œë§Œ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); state.editMode=!state.editMode; btnEdit.textContent = state.editMode? "í¸ì§‘ ì¢…ë£Œ":"í¸ì§‘ ëª¨ë“œ"; renderStudents(); };
btnSelectAll.onclick=()=>{ if(!state.teacherMode) return; rosterFor(state.cls).forEach(n=>state.checks[n]=true); renderStudents(); };
btnClear.onclick=()=>{ if(!state.teacherMode) return; state.checks={}; renderStudents(); };

btnPhotoBulk.onclick=()=>{ if(!state.teacherMode) return; filePhotoBulk.click(); };
filePhotoBulk.onchange=async()=>{ if(!state.teacherMode) return; const files=[...filePhotoBulk.files]; if(!files.length) return;
  const roster = rosterFor(state.cls); const notMatched=[];
  for (const f of files){
    const dataUrl = await toThumb(f, 180);
    const guess = roster.find(n => f.name.includes(n));
    if (guess) setPhoto(state.cls, guess, dataUrl); else notMatched.push(f.name);
  }
  if (notMatched.length) alert("ì´ë¦„ì´ íŒŒì¼ëª…ì— ì—†ëŠ” í•­ëª©:\n- "+notMatched.join("\n"));
  renderStudents();
};
btnPhotoClear.onclick=()=>{ if(!state.teacherMode) return; if(!confirm("ì´ ë°˜ì˜ ëª¨ë“  ì‚¬ì§„ì„ ì œê±°í• ê¹Œìš”?")) return; clearPhotos(state.cls); renderStudents(); };

btnDownload.onclick=()=>{ const payload=buildPayload(); const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`${state.date}_${state.cls}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
};

/* ====================== GitHub ì €ì¥ ====================== */
function openSettings(){
  const m=byId("modal"); m.classList.add("show");
  byId("ghOwner").value = SETTINGS.owner||""; byId("ghRepo").value=SETTINGS.repo||"";
  byId("ghBranch").value=SETTINGS.branch||"main"; byId("ghBase").value=SETTINGS.base||"data"; byId("ghToken").value=SETTINGS.token||"";
  byId("teacherPin").value = TEACHER_PIN || "";
}
byId("btn-close-modal").onclick=()=>byId("modal").classList.remove("show");
byId("btn-save-settings").onclick=()=>{ 
  SETTINGS={ owner:byId("ghOwner").value.trim(), repo:byId("ghRepo").value.trim(),
    branch:byId("ghBranch").value.trim()||"main", base:byId("ghBase").value.trim()||"data",
    token:byId("ghToken").value.trim() };
  save(LS_SETTINGS,SETTINGS);
  TEACHER_PIN = byId("teacherPin").value.trim();
  if(TEACHER_PIN) localStorage.setItem(LS_PIN, TEACHER_PIN); else localStorage.removeItem(LS_PIN);
  byId("modal").classList.remove("show"); alert("ì„¤ì • ì €ì¥ ì™„ë£Œ");
};
byId("btn-reset-settings").onclick=()=>{ if(!confirm("ì„¤ì •ì„ ì´ˆê¸°í™”í• ê¹Œìš”?")) return; SETTINGS={owner:"",repo:"",branch:"main",base:"data",token:""}; save(LS_SETTINGS,SETTINGS); localStorage.removeItem(LS_PIN); TEACHER_PIN=""; byId("modal").classList.remove("show"); };

btnSaveGh.onclick=saveToGitHub;
async function saveToGitHub(){
  if(!state.teacherMode) return alert("êµì‚¬ ëª¨ë“œì—ì„œë§Œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
  const {owner,repo,branch,base,token}=SETTINGS;
  if(!owner||!repo||!token){alert("ì„¤ì •(Owner/Repo/Token)ì„ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”.");return;}
  const path = `${base}/${state.date}/${state.cls}.json`;
  const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
  let sha=undefined;
  const getRes = await fetch(`${url}?ref=${encodeURIComponent(branch)}`,{headers:{Authorization:`Bearer ${token}`,Accept:"application/vnd.github+json"}});
  if(getRes.status===200){ const j=await getRes.json(); sha=j.sha; }
  const content = btoa(unescape(encodeURIComponent(JSON.stringify(buildPayload(),null,2))));
  const body = {message:`Uniform check: ${state.date} ${state.cls}`, content, branch, sha };
  const res = await fetch(url,{method:"PUT",headers:{Authorization:`Bearer ${token}`,"Content-Type":"application/json",Accept:"application/vnd.github+json"},body:JSON.stringify(body)});
  if(res.ok){
    const logs = load(LS_LOGS)||[]; logs.push({...buildPayload(), savedAt:new Date().toISOString()}); save(LS_LOGS,logs);
    alert("GitHub ì €ì¥ ì„±ê³µ!");
  } else {
    alert("ì €ì¥ ì‹¤íŒ¨: "+await res.text());
  }
}
function buildPayload(){
  const roster = rosterFor(state.cls);
  const items = roster.map((name,i)=>({no:i+1,name,worn:!!state.checks[name]}));
  const worn = items.filter(x=>x.worn).length;
  return { date:state.date, class:state.cls, total:roster.length, worn, rate: roster.length? Math.round(100*worn/roster.length):0, items };
}

/* ====================== ì›”ë³„ í†µê³„(ë°˜) ====================== */
let chartClass=null, chartGrade=null, classCountsCache=null, gradeAggCache=null;
byId("btn-stat-local").onclick=()=>{ const {counts, roster}=calcClassLocal(); classCountsCache=counts; renderStatTable(counts, roster); drawClassChart(counts, roster); };
byId("btn-stat-github").onclick=async()=>{ const r=await calcClassFromGitHub(); if(!r) return; classCountsCache=r.counts; renderStatTable(r.counts, r.roster); drawClassChart(r.counts, r.roster); };
byId("btn-stat-csv").onclick=()=>{ const roster = rosterFor(state.cls); const rows=[["ë²ˆí˜¸","ì´ë¦„","ì›” ëˆ„ì (âœ…)"]]; roster.forEach((n,i)=>rows.push([i+1,n,(classCountsCache&&classCountsCache[n])||0])); downloadCSV(rows,`stats_${state.cls}_${monthInput.value||monthStr(new Date())}.csv`); };

function calcClassLocal(){
  const month=(byId("monthInput").value||monthStr(new Date()));
  const logs = load(LS_LOGS)||[];
  const cls=state.cls, roster=rosterFor(cls), counts={};
  logs.filter(l=>l.class===cls && (l.date||"").startsWith(month)).forEach(l=>{
    l.items.forEach(it=>{ if(it.worn) counts[it.name]=(counts[it.name]||0)+1; });
  });
  return {counts, roster};
}
async function calcClassFromGitHub(){
  const {owner,repo,branch,base,token}=SETTINGS;
  if(!owner||!repo||!token){alert("GitHub ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.");return null;}
  const month=(byId("monthInput").value||monthStr(new Date()));
  const pathPrefix=`${base}/${month}`;
  const b=await fetch(`https://api.github.com/repos/${owner}/${repo}/branches/${encodeURIComponent(branch)}`,{headers:{Authorization:`Bearer ${token}`,Accept:"application/vnd.github+json"}}); if(!b.ok){alert("ë¸Œëœì¹˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");return null;}
  const sha=(await b.json()).commit?.sha;
  const t=await fetch(`https://api.github.com/repos/${owner}/${repo}/git/trees/${sha}?recursive=1`,{headers:{Authorization:`Bearer ${token}`,Accept:"application/vnd.github+json"}}); if(!t.ok){alert("íŒŒì¼ íŠ¸ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");return null;}
  const list=(await t.json()).tree||[];
  const targets=list.filter(n=>n.type==="blob" && n.path.startsWith(pathPrefix) && n.path.endsWith(`${state.cls}.json`));
  const counts={}, roster=rosterFor(state.cls);
  for(const n of targets){
    const raw=`https://raw.githubusercontent.com/${owner}/${repo}/${encodeURIComponent(branch)}/${n.path}`;
    const j=await (await fetch(raw)).json().catch(()=>null); if(!j||!j.items) continue;
    j.items.forEach(it=>{ if(it.worn) counts[it.name]=(counts[it.name]||0) + 1; });
  }
  return {counts, roster};
}
function renderStatTable(counts, roster){
  statTable.innerHTML=""; roster.forEach((n,i)=>{ const tr=document.createElement("tr"); tr.innerHTML=`<td>${i+1}</td><td>${n}</td><td>${counts[n]||0}</td>`; statTable.appendChild(tr); });
}
function drawClassChart(counts, roster){
  const labels=roster; const data=labels.map(n=>counts[n]||0);
  if(chartClass) chartClass.destroy();
  chartClass=new Chart(chartClassCtx,{ type:"bar", data:{labels, datasets:[{label:`${(byId("monthInput").value||monthStr(new Date()))} ${state.cls} ì›” ëˆ„ì (âœ…)`, data}]}, options:{plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}});
}

/* ====================== í•™ë…„ ì „ì²´ í†µê³„ ====================== */
byId("btn-grade-local").onclick=()=>{ gradeAggCache=calcGradeLocal(); renderGradeTable(gradeAggCache); drawGradeChart(gradeAggCache); };
byId("btn-grade-github").onclick=async()=>{ gradeAggCache=await calcGradeFromGitHub(); if(!gradeAggCache) return; renderGradeTable(gradeAggCache); drawGradeChart(gradeAggCache); };
byId("btn-grade-csv").onclick=()=>{ if(!gradeAggCache){alert("ë¨¼ì € í†µê³„ë¥¼ ê³„ì‚°í•˜ì„¸ìš”.");return;} const rows=[["ë°˜","íŒŒì¼ ìˆ˜(ì¼ìˆ˜)","ì›” ëˆ„ì (âœ… í•©ê³„)"]]; gradeAggCache.rows.forEach(r=>rows.push([r.cls,r.files,r.total])); downloadCSV(rows,`grade_${state.grade}_${byId("gradeMonthInput").value||monthStr(new Date())}.csv`); };

function calcGradeLocal(){
  const month=(byId("gradeMonthInput").value||monthStr(new Date()));
  const logs=load(LS_LOGS)||[]; const grade=state.grade; const bans=GRADES[grade]||[];
  const rows=[]; bans.forEach(ban=>{
    const cls=classKey(grade,ban);
    const filtered=logs.filter(l=>l.class===cls && (l.date||"").startsWith(month));
    let total=0; filtered.forEach(l=>{ l.items.forEach(it=>{ if(it.worn) total++; }); });
    rows.push({cls, files: new Set(filtered.map(l=>l.date)).size, total});
  });
  return { rows };
}
async function calcGradeFromGitHub(){
  const {owner,repo,branch,base,token}=SETTINGS; if(!owner||!repo||!token){alert("GitHub ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.");return null;}
  const month=(byId("gradeMonthInput").value||monthStr(new Date())); const grade=state.grade; const bans=GRADES[grade]||[];
  const b=await fetch(`https://api.github.com/repos/${owner}/${repo}/branches/${encodeURIComponent(branch)}`,{headers:{Authorization:`Bearer ${token}`,Accept:"application/vnd.github+json"}}); if(!b.ok){alert("ë¸Œëœì¹˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");return null;}
  const sha=(await b.json()).commit?.sha;
  const t=await fetch(`https://api.github.com/repos/${owner}/${repo}/git/trees/${sha}?recursive=1`,{headers:{Authorization:`Bearer ${token}`,Accept:"application/vnd.github+json"}}); if(!t.ok){alert("íŒŒì¼ íŠ¸ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");return null;}
  const list=(await t.json()).tree||[]; const rows=[];
  for(const ban of bans){
    const cls=classKey(grade,ban); const prefix=`${base}/${month}/`; const targets=list.filter(n=>n.type==="blob" && n.path.startsWith(prefix) && n.path.endsWith(`${cls}.json`));
    let total=0; const dates=new Set();
    for(const n of targets){
      const raw=`https://raw.githubusercontent.com/${owner}/${repo}/${encodeURIComponent(branch)}/${n.path}`;
      const j=await (await fetch(raw)).json().catch(()=>null); if(!j||!j.items||!j.date) continue;
      dates.add(j.date); j.items.forEach(it=>{ if(it.worn) total++; });
    }
    rows.push({cls, files:dates.size, total});
  }
  return { rows };
}
function renderGradeTable(agg){
  const tb=document.getElementById("gradeTable").querySelector("tbody"); tb.innerHTML="";
  agg.rows.forEach(r=>{ const tr=document.createElement("tr"); tr.innerHTML=`<td>${r.cls}</td><td>${r.files}</td><td>${r.total}</td>`; tb.appendChild(tr); });
}
function drawGradeChart(agg){
  const labels=agg.rows.map(r=>r.cls); const data=agg.rows.map(r=>r.total);
  if(chartGrade) chartGrade.destroy();
  chartGrade=new Chart(chartGradeCtx,{type:"bar",data:{labels,datasets:[{label:`${(byId("gradeMonthInput").value||monthStr(new Date()))} ${state.grade} ì›” ëˆ„ì (âœ… í•©ê³„)`,data} ]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
}

/* ====================== ìœ í‹¸ ====================== */
function downloadCSV(rows, filename){
  const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"}); const a=document.createElement("a");
  a.href=URL.createObjectURL(blob); a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
}
function pickImage(){ return new Promise(res=>{ const i=document.createElement("input"); i.type="file"; i.accept="image/*"; i.onchange=()=>res(i.files[0]||null); i.click(); }); }
function toThumb(file, size=180){
  return new Promise((resolve,reject)=>{
    const img=new Image(); const fr=new FileReader();
    fr.onload=()=>{ img.onload=()=>{ 
        const canvas=document.createElement("canvas"); const s=size; canvas.width=s; canvas.height=s; 
        const ctx=canvas.getContext("2d"); ctx.fillStyle="#fff"; ctx.fillRect(0,0,s,s);
        const r = Math.min(s/img.width, s/img.height); const w=img.width*r, h=img.height*r;
        ctx.drawImage(img,(s-w)/2,(s-h)/2,w,h); resolve(canvas.toDataURL("image/jpeg",0.86));
      }; img.onerror=reject; img.src=fr.result; 
    }; fr.onerror=reject; fr.readAsDataURL(file);
  });
}

/* ====================== ì‹œì‘ ====================== */
function updateGradeLabel(){ gradeLabel.textContent = state.grade; }
function init(){ dateInput.value = state.date; }
init();
</script>
</body>
</html>
